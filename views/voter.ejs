<%-include admin_common/header.ejs%>
<!-- Modal -->
<div class="modal fade" id="voterAddModal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body row">
        <!-- msg -->
        <div class="col-12 succes-msg text-success text-center"></div>
        <div class="col-12 err-msg text-success text-danger"></div>

        <div class="col-12">
          <!--name-->
          <div class="form-group">
            <input type="text" class="form-control" id="name" placeholder="Full name">
          </div>
          <!-- email -->
          <div class="form-group">
            <input type="email" class="form-control" id="email" placeholder="Email">
          </div>
          <!-- phone number -->
          <div class="form-group">
            <input type="text" class="form-control" id="phno" placeholder="Phone number" minlength="10" maxlength="12">
          </div>
          <!-- aadhar number -->
          <div class="form-group">
            <input type="text" class="form-control" id="aadhar" placeholder="Aadhar number" minlength="12"
              maxlength="12" minlength="12">
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button class="btn btn-primary disabled" id="botn" type="button" disabled>Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- candidate update modal -->
<div class="modal fade" id="voterUpdateModal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- msg -->
        <div class="col-12 succes-msg text-success text-center"></div>
        <div class="col-12 err-msg text-success text-danger"></div>
        <!-- name-->
        <div class="form-group">
          <input type="text" class="form-control" id="cname" placeholder="Full name">
        </div>
        <!-- email -->
        <div class="form-group">
          <input type="email" class="form-control" id="cemail" placeholder="Email">
        </div>
        <!-- phone number -->
        <div class="form-group">
          <input type="text" class="form-control" id="cphno" placeholder="Phone number">
        </div>
        <!-- aadhar number -->
        <div class="form-group">
          <input type="text" class="form-control" id="caadhar" placeholder="Aadhar number" maxlength="12"
            minlength="12">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="voterDetailUpdate" type="button">Save</button>
      </div>
    </div>
  </div>
</div>

<section id="votersTable">
  <div class="container">
    <div class="row mt-3">
      <div class="col-12 text-right">
        <h4 class="float-left">Candidtaes</h4>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#voterAddModal">
          Add new +
        </button>
        <button type="button" class="btn btn-warning text-white csvfileSelect">
          <i class="fa fa-file" aria-hidden="true"></i>
        </button>
        <input type="file" id="csvFile" accept=".csv">
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12">
        <table class="table table-responsive">
          <thead>
            <tr>
              <th>name</th>
              <th>email</th>
              <th>phno</th>
              <th>aadhar</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% for (i=0 ; i<data.length; i++){%>
            <tr>
              <td class="nm"><%=data[i].name%></td>
              <td class="em"><%=data[i].email%></td>
              <td class="ph"><%=data[i].phone%></td>
              <td class="aa"><%=data[i].aadhar%></td>
              <td>
                <button class="btn btn-success voterEdit" data-toggle="modal" data-target="#voterUpdateModal"
                  value="<%=data[i]._id%>">
                  <i class="fas fa-edit" aria-hidden="true"></i>
                </button>
              </td>
              <td>
                <button class="btn btn-danger voterDel" value="<%=data[i]._id%>">
                  <i class="fa fa-trash" aria-hidden="true"></i>
                </button>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<%-include admin_common/footer.ejs%>
<script>
  $(document).ready(function () {
    $("#csvFile").hide();
    $(".csvfileSelect").click(function () {
      $("#csvFile").toggle();
    });
    $("#csvFile").change(function () {
      var formData = new FormData();
      formData.append("file", document.getElementById("csvFile").files[0]);
      $.ajax({
        url: "csvFileUpload",
        type: "POST",
        data: formData,
        contentType: false,
        processData: false,
        success: function (data) {
          window.location.reload();
        },
        error: function (data) {
          toastr.error(data);
        }
      });

    });

    //FrontEnd Validation
    //START
    //=======================================================================================================================================================
    $(":input").keyup(function () {
      if ($("#name").val() != "" && $("#email").val() != "" && $("#phno").val().length >= 10 && $("#aadhar").val().length == 12) {
        $("#botn").prop("disabled", false).removeClass("disabled");
        toastr.warning("fileds can't be empty");
      }
      else {
        $("#botn").prop("disabled", true).addClass("disabled");
      }
    });
    //=======================================================================================================================================================
    //END


    //Voter Adding Function
    //START
    //=======================================================================================================================================================
    $("#botn").click(function () {
      var voter = {
        name: $("#name").val(),
        email: $("#email").val(),
        phone: $("#phno").val(),
        aadhar: $("#aadhar").val()
      }
      $.ajax({
        url: "voterCreate",
        type: "POST",
        data: { voter: JSON.stringify(voter) },
        success: function (data) {
          if (data[0] == false) {
            toastr.error(data[1]);
          }
          else window.location.reload();
        },
        error: function (data) {
          toastr.error(data);
        }
      });
    });
    //=======================================================================================================================================================
    //END


    //Voter Update Function
    //START
    //=======================================================================================================================================================
    $(".voterEdit").click(function () {
      var id = $(this).val();
      $("#cname").val($(this).closest('tr').find('.nm').text());
      $("#cemail").val($(this).closest('tr').find('.em').text());
      $("#cphno").val($(this).closest('tr').find('.ph').text());
      $("#caadhar").val($(this).closest('tr').find('.aa').text());

      $('#voterDetailUpdate').click(function () {
        var voter = {
          "name": $('#cname').val(),
          "email": $('#cemail').val(),
          "phone": $('#cphno').val(),
          "aadhar": $('#caadhar').val()
        }
        $.ajax({
          url: "voterUpdate",
          type: "POST",
          data: { voter: JSON.stringify(voter), id: id },
          success: function (data) {
            toastr.success("Updated");
            window.location.reload();
          },
          error: function (data) {
            console.log(data);
          }
        });
      });

    });
    //=======================================================================================================================================================
    //END

    //Voter Delete Function
    //START
    //=======================================================================================================================================================
    $(".voterDel").click(function () {
      var btn_id = $(this).val();
      $(this).closest("tr").hide();
      $.ajax({
        url: "voterDel",
        type: "POST",
        data: { del_id: btn_id },
        success: function (data) {
          toastr.success("Deleted");
        },
        error: function (data) {
          toastr.error(data)
        }
      });
    });
    //=======================================================================================================================================================
    //END

  });
</script>